<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" data-name="vs/editor/editor.main" href="../monaco-editor/min/vs/editor/editor.main.css" />
<style>
	* {
		margin: 0;
		padding: 0;
	}
	body {
		background-color: black;
	}
	#unity {
		display: block;
		border: none;
		width: calc(100vw - 600px);
		height: 100vh;
	}
	#panel {
		color: white;
		position: absolute;
		top: 0;
		right: 0;
		width: 600px;
	}
	#editor {
		height: 600px;
		width: 600px;
	}
	.button {
		border: none;
    background: #460046;
    color: white;
		margin-right: 8px;
    padding: 10px;
	}
</style>
<iframe id="unity" src="/Unity/"></iframe>
<div id="panel">
	<div id="editor"></div>
	<div>
		<div>
			<button class="button" id="compileButton">RUN</button>
			<button class="button" id="deleteAllButton">RESET</button>
		</div>
		<div>
			<div id="process-message"></div>
		</div>
	</div>
</div>

<script>
	var require = { paths: { vs: '../monaco-editor/min/vs' } };
</script>
<script src="../monaco-editor/min/vs/loader.js"></script>
<script src="../monaco-editor/min/vs/editor/editor.main.nls.js"></script>
<script src="../monaco-editor/min/vs/editor/editor.main.js"></script>
<script>
	const initialCode = `
import { createPrimitive, Object, PrimitiveType, } from "sndbxr/Object"
import { Vector2 } from "sndbxr/Vector2"
import { Vector3 } from "sndbxr/Vector3"

const objects: Object[] = [];
let speed: Vector2 = new Vector2(0, 0.6)
const g: f32 = 0.01
const mEarth: f32 = 1
const mSun: f32 = 100
let sunPos = new Vector2(1, 0)
let earthPos = new Vector2(3, 0)

const dt: f32 = 0.01
let sunR: f32 = 0
const sunDR: f32 = 0.0005

export function update(): void {
  const sun = objects[0]
  const earth = objects[1]
  const a = g * mSun * mEarth / sunPos.distanceToSquared(earthPos)
  const fn = sunPos.sub(earthPos).normalize()
  const av = fn.multiplyScalar(a as f32)
  earthPos = earthPos.add(speed.multiplyScalar(dt))
  earth.setPosition(new Vector3(earthPos.x, earthPos.y, 0))
  speed = speed.add(av.multiplyScalar(dt))
  sunPos = new Vector2(Math.cos(sunR) as f32, Math.sin(sunR) as f32)
  sun.setPosition(new Vector3(sunPos.x, sunPos.y, 0))
  sunR += sunDR
}

export function start(): void {
  const sun = createPrimitive(PrimitiveType.SPHERE)
  const earth = createPrimitive(PrimitiveType.SPHERE)
	sun.setPosition(new Vector3(sunPos.x, sunPos.y, 0))
	objects.push(sun)
	earth.setPosition(new Vector3(earthPos.x, earthPos.y, 0))
	earth.setScale(new Vector3(0.2, 0.2, 0.2))
	objects.push(earth)
}
`
	var editor = monaco.editor.create(document.getElementById('editor'), {
		value: initialCode,
		language: 'typescript'
	});
	monaco.editor.setTheme("vs-dark")
	window.addEventListener("DOMContentLoaded", () => {
		const unityFrame = document.getElementById("unity")
		const messageContainer = document.getElementById("process-message")
		const compileButton = document.getElementById("compileButton")
		const resetButton = document.getElementById("deleteAllButton")

		compileButton.addEventListener("click", async () => {
			const code = editor.getValue()
			messageContainer.innerText = "Compiling"
			const res = await fetch("/api/compile", {
				method: "POST",
				headers: {
					"Content-Type": "text/plain"
				},
				body: code
			})
			if (res.status === 200) {
				messageContainer.innerText = "Compiled"
				const json = await res.json()
      	const url = "/artifacts/" + json.id + ".wasm"
      	unityFrame.contentWindow.connector.requestLoad(url)
			} else {
				const json = await res.json()
				messageContainer.innerText = "Failed" + json.message
			}
		})

		resetButton.addEventListener("click", () => {
			unityFrame.contentWindow.deleteAllSandboxes()	
		})
	})
</script>